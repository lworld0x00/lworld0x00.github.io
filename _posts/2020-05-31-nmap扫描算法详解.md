---
layout:     post
title:      "nmap端口扫描算法详解"
subtitle:   "顺便看看代码～"
date:       2020-05-31 12:00:00
author:     "不知道什么时候能写完的小你同学"
header-img: "img/post-bg-universe.jpg"
catalog: true
tags:
    - TCP/IP 
---

`nmap`中有不少扫描算法，包括`-sS(TCP SYN scan)/-sT(TCP connect scan)/-sU(UDP scans)`。

### 基础知识

#### TCP三次握手

在详细分析`nmap`扫描算法之前，不得不先分析一下`TCP`建立连接的三次握手 ，三次握手过程如下图所示：

![img](img/in-post/tcp_three_handshakes.jpg)



​		三次握手建立连接的数据包(使用命令为 `ssh`)如下所示：

​		![tcp第一次握手](img/tcp_three_0.jpg)

​		在第一次握手的时候，标志位会设成`SYN`，同时会发送一个`Seq Number`，在这个数据包中 `Seq Number = 2186387149`

​		

![TCP建立连接第二次握手](img/tcp_1.jpg)

​	第二次握手的时候，标志位会被设置为`SYN和ACK`，同时 `ACK Number = Seq Number + 1`， `Seq Number = 2071329386`

​	![TCP建立连接第三次握手](img/tcp_2.jpg)

​	第三次握手的时候，标志位会被设置为`ACK`，同时 `ACK Number = Seq Number + 1`

以上是正常建立三次握手的过程。

​	当我们想要请求连接一个不存在的端口时，会发送什么样的数据报呢？

根据《TCP/IP详解：卷1》18.7.1可知，当连接到不存在端口的时候，该端口如果没有进程正在听，对于`UDP`，当一个数据报到达目的端口时，该端口没在使用，它将产生一个`ICMP`端口不可达的信息。而`TCP`则使用复位。

### nmap扫描算法

#### TCP SYN scan

1. nmap命令：-sS

2. open端口流量分析

![](/img/nmap_sS_1.jpg)

​																		上述数据报所使用的命令为 `nmap -sS IP`，扫描结果`443`是开放的

我们以`443`端口扫描为例，分析`324,334,335`数据报。

```c
37796->443 SYN
443->37796 SYN,ACK
37796->443 RST
```

可以看到，当使用`TCP SYN scan`进行扫描的时候，会发送三个数据报：

---

1. `nmap`发送 `SYN` 数据报 给指定端口 ---> nmap发送数据报
2. 收到返回`SYN ACK`数据报 --->目标IP发回数据报
3. `nmap`发送`RST`数据报到目标端口

---

以上两步和建立`TCP`连接的前两次握手是相同的

3. filtered端口数据报分析

![](/img/nmap_sS_2.jpg)

我们以`3306`端口为例，扫描结果显示该端口为`filtered`状态，分析`344,397`数据报

```
48501--->3306 SYN
48502--->3306 SYN
```

可以看到，当`nmap`判断一个端口是否为`filterd`状态时，会发送两个`SYN`数据报，如果没有收到任何回应，则判断该端口为`filtered`状态。两个数据报之间间隔多长时间，由nmap自己决定。

4. close端口数据报分析

目前没有抓到关闭端口的数据报，无法分析。`nmap`官方文档显示，如果目标端口返回的是`RST`数据报，则端口为关闭状态。

#### TCP Connect Scan (-sT)

1. nmap命令：-sT

2. open端口数据报分析：

![](/img/nmap_sT_1.jpg)

以`443` 端口为例，分析`31,32,33,34`数据报。

```
52610-->443  SYN
443--->52610 ACK, SYN
52610--->443 ACK
52610--->443 RST, ACK
```

`31-33`数据报可以是建立完成的`TCP`三次握手，`34`数据报则是发送`RST`数据报结束`TCP`连接。所以相比起`TCP Connect Scan`，`TCP SYN Scan`更加隐秘。

3. close端口数据报分析

![](/img/nmap_sT_2.jpg)

使用`TCP Connect Scan`扫描时，对于已经关闭的端口并不会做再次发送`SYN`数据报的操作，所以相比起`SYN Scan`，这种扫描方式不会造成网络拥堵。

#### UDP Scan (-sU)



### 其他扫描方式

#### socket扫描

1. 代码

```python
async def Scan(ip, port):
    try:
        reader, writer = await asyncio.open_connection(host=ip, port=port)
        writer.close()
        await writer.wait_closed()
    except Exception as e:
        return False
    else:
        result_port.append(port)
        return result_port
```

2. 数据报分析

![](/img/socket_1.jpg)

这一系列的数据报为通过socket方式扫描目的IP的80端口，返回的数据报。其中`584,587,588`三个数据报为TCP建立连接的三次握手包。



---

参考文章：

1. 《TCP/IP详解：卷1》